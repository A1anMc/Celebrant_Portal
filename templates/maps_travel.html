{% extends "base.html" %}

{% block title %}Maps & Travel - Marriage Celebrant Portal{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-map-marked-alt"></i> Maps & Travel Management</h1>
        <div>
            <button type="button" class="btn btn-primary" id="batch-calculate-btn">
                <i class="fas fa-calculator"></i> Calculate All Distances
            </button>
        </div>
    </div>

    <!-- Travel Settings Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-cogs"></i> Travel Fee Settings</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="base-fee" class="form-label">Base Fee ($)</label>
                        <input type="number" step="0.01" class="form-control" id="base-fee" value="0" readonly>
                        <small class="text-muted">Fixed fee regardless of distance</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="rate-per-km" class="form-label">Rate per KM ($)</label>
                        <input type="number" step="0.01" class="form-control" id="rate-per-km" value="1.50" readonly>
                        <small class="text-muted">Cost per kilometer traveled</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="free-distance" class="form-label">Free Distance (KM)</label>
                        <input type="number" class="form-control" id="free-distance" value="20" readonly>
                        <small class="text-muted">Distance included in base fee</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="home-address" class="form-label">Home Address</label>
                        <input type="text" class="form-control" id="home-address" value="Melbourne, VIC, Australia" readonly>
                        <small class="text-muted">Your starting location</small>
                    </div>
                </div>
            </div>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Zone-Based Pricing:</strong> 
                <ul class="mb-0 mt-2">
                    <li><strong>Zone 1 (0-5km):</strong> $10</li>
                    <li><strong>Zone 2 (5-10km):</strong> $20</li>
                    <li><strong>Zone 3 (10-15km):</strong> $30</li>
                    <li><strong>Zone 4 (15-25km):</strong> $40</li>
                    <li><strong>Zone 5 (25-40km):</strong> $50</li>
                    <li><strong>Zone 5+ (40km+):</strong> $50 + $1.25/km beyond 40km</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Venues and Travel Information -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Venues & Travel Information</h5>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="view-map-btn">
                    <i class="fas fa-map"></i> Map View
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary active" id="view-list-btn">
                    <i class="fas fa-list"></i> List View
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading venue information...</p>
            </div>

            <!-- List View -->
            <div id="list-view" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Couple</th>
                                <th>Venue</th>
                                                    <th>Distance</th>
                    <th>Zone</th>
                    <th>Travel Time</th>
                    <th>Travel Fee</th>
                                <th>Ceremony Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="venues-table-body">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Map View -->
            <div id="map-view" style="display: none;">
                <div id="map-not-configured" class="mb-3" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Note:</strong> Map view requires Google Maps API key to be configured.
                    </div>
                </div>
                <div id="google-map" style="height: 500px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                    <div id="map-placeholder" class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center">
                            <i class="fas fa-map fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Loading map...</p>
                        </div>
                    </div>
                    <iframe id="embedded-map" style="display: none;" width="100%" height="500" frameborder="0" style="border:0" allowfullscreen="" aria-hidden="false" tabindex="0"></iframe>
                </div>
            </div>

            <!-- Empty State -->
            <div id="empty-state" style="display: none;" class="text-center py-5">
                <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                <h5>No venues found</h5>
                <p class="text-muted">Add ceremony locations to your couples to see travel information here.</p>
                <a href="{{ url_for('couples_list') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Manage Couples
                </a>
            </div>
        </div>
    </div>

    <!-- Quick Venue Lookup -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-search"></i> Quick Venue Lookup</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="text" class="form-control" id="venue-search" 
                               placeholder="Enter venue name or address...">
                        <button type="button" class="btn btn-primary" id="search-venue-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div id="venue-search-results" class="mt-3" style="display: none;">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title">Venue Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Address:</strong> <span id="venue-address">-</span></p>
                                <p><strong>Distance:</strong> <span id="venue-distance">-</span></p>
                                <p><strong>Travel Time:</strong> <span id="venue-time">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Zone:</strong> <span id="venue-zone" class="badge bg-secondary">-</span></p>
                                <p><strong>Travel Fee:</strong> <span id="venue-fee">-</span></p>
                                <a id="venue-maps-link" href="#" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt"></i> View in Google Maps
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingState = document.getElementById('loading-state');
    const listView = document.getElementById('list-view');
    const mapView = document.getElementById('map-view');
    const emptyState = document.getElementById('empty-state');
    const venuesTableBody = document.getElementById('venues-table-body');
    
    const viewMapBtn = document.getElementById('view-map-btn');
    const viewListBtn = document.getElementById('view-list-btn');
    const batchCalculateBtn = document.getElementById('batch-calculate-btn');
    const searchVenueBtn = document.getElementById('search-venue-btn');
    const venueSearchInput = document.getElementById('venue-search');
    const venueSearchResults = document.getElementById('venue-search-results');
    
    let currentView = 'list';
    let venuesData = [];
    let mapsConfigured = false;
    let homeAddress = '';
    
    // Initialize page
    checkMapsConfiguration();
    loadVenuesData();
    
    // View toggle handlers
    viewListBtn.addEventListener('click', () => switchView('list'));
    viewMapBtn.addEventListener('click', () => switchView('map'));
    
    // Batch calculate handler
    batchCalculateBtn.addEventListener('click', batchCalculateDistances);
    
    // Venue search handler
    searchVenueBtn.addEventListener('click', searchVenue);
    venueSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchVenue();
        }
    });
    
    function checkMapsConfiguration() {
        fetch('/api/maps/config')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mapsConfigured = data.configured;
                    homeAddress = data.home_address;
                    
                    if (!mapsConfigured) {
                        document.getElementById('map-not-configured').style.display = 'block';
                        document.getElementById('map-placeholder').innerHTML = `
                            <div class="text-center">
                                <i class="fas fa-map fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Interactive map will appear here when Google Maps API is configured</p>
                            </div>
                        `;
                    } else {
                        loadMapView();
                    }
                }
            })
            .catch(error => {
                console.error('Error checking maps configuration:', error);
                document.getElementById('map-not-configured').style.display = 'block';
            });
    }
    
    function loadMapView() {
        // Show a map centered on the home address with venue markers
        if (mapsConfigured && venuesData.length > 0) {
            // Create a simple embedded map showing the home location
            const mapPlaceholder = document.getElementById('map-placeholder');
            const embeddedMap = document.getElementById('embedded-map');
            
            // Use the first venue as destination for demo, or just show home location
            const destination = venuesData.length > 0 ? venuesData[0].ceremony_location : homeAddress;
            const apiKey = '{{ maps_api_key }}';
            const embedUrl = `https://www.google.com/maps/embed/v1/directions?key=${apiKey}&origin=${encodeURIComponent(homeAddress)}&destination=${encodeURIComponent(destination)}&mode=driving`;
            
            embeddedMap.src = embedUrl;
            mapPlaceholder.style.display = 'none';
            embeddedMap.style.display = 'block';
        }
    }
    
    function switchView(view) {
        currentView = view;
        
        if (view === 'list') {
            listView.style.display = 'block';
            mapView.style.display = 'none';
            viewListBtn.classList.add('active');
            viewMapBtn.classList.remove('active');
        } else {
            listView.style.display = 'none';
            mapView.style.display = 'block';
            viewListBtn.classList.remove('active');
            viewMapBtn.classList.add('active');
            
            // Load map when switching to map view
            if (mapsConfigured) {
                loadMapView();
            }
        }
    }
    
    function loadVenuesData() {
        // Load couples with ceremony locations
        fetch('/api/export/couples')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    venuesData = data.couples.filter(couple => couple.ceremony_location);
                    displayVenues();
                } else {
                    showError('Failed to load venues data');
                }
            })
            .catch(error => {
                console.error('Error loading venues:', error);
                showError('Failed to load venues data');
            })
            .finally(() => {
                loadingState.style.display = 'none';
            });
    }
    
    function displayVenues() {
        if (venuesData.length === 0) {
            emptyState.style.display = 'block';
            return;
        }
        
        listView.style.display = 'block';
        
        venuesTableBody.innerHTML = '';
        
        venuesData.forEach(couple => {
            const row = document.createElement('tr');
            
            const travelFee = couple.travel_fee || 0;
            const feeClass = travelFee > 100 ? 'text-warning' : travelFee > 50 ? 'text-info' : 'text-success';
            
            row.innerHTML = `
                <td>
                    <strong>${couple.partner1_name} & ${couple.partner2_name}</strong><br>
                    <small class="text-muted">${couple.status}</small>
                </td>
                <td>
                    <span title="${couple.ceremony_location}">${truncateText(couple.ceremony_location, 30)}</span>
                </td>
                <td>
                    <span id="distance-${couple.id}">
                        ${couple.distance_info ? couple.distance_info.distance_text : '-'}
                    </span>
                </td>
                <td>
                    <span id="zone-${couple.id}" class="badge bg-secondary">
                        ${couple.distance_info && couple.distance_info.travel_zone ? couple.distance_info.travel_zone : '-'}
                    </span>
                </td>
                <td>
                    <span id="time-${couple.id}">
                        ${couple.distance_info ? couple.distance_info.duration_text : '-'}
                    </span>
                </td>
                <td>
                    <span class="${feeClass}" id="fee-${couple.id}">
                        $${travelFee.toFixed(2)}
                    </span>
                </td>
                <td>
                    ${couple.ceremony_date ? new Date(couple.ceremony_date).toLocaleDateString() : '-'}
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="calculateSingleDistance(${couple.id})">
                            <i class="fas fa-calculator"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" 
                                onclick="viewInMaps('${couple.ceremony_location}')">
                            <i class="fas fa-map"></i>
                        </button>
                        <a href="/couples/${couple.id}/edit" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                </td>
            `;
            
            venuesTableBody.appendChild(row);
        });
        
        // Update map view if it's currently active
        if (currentView === 'map' && mapsConfigured) {
            loadMapView();
        }
    }
    
    function batchCalculateDistances() {
        batchCalculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
        batchCalculateBtn.disabled = true;
        
        fetch('/api/maps/batch-calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(`Updated travel information for ${data.updated_couples} couples`);
                loadVenuesData(); // Reload data
            } else {
                showError('Failed to calculate distances: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to calculate distances');
        })
        .finally(() => {
            batchCalculateBtn.innerHTML = '<i class="fas fa-calculator"></i> Calculate All Distances';
            batchCalculateBtn.disabled = false;
        });
    }
    
    function searchVenue() {
        const venueName = venueSearchInput.value.trim();
        
        if (!venueName) {
            alert('Please enter a venue name or address');
            return;
        }
        
        searchVenueBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
        searchVenueBtn.disabled = true;
        
        fetch('/api/maps/venue-info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                venue_name: venueName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayVenueSearchResults(data.venue_info);
            } else {
                showError('Venue not found: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to search venue');
        })
        .finally(() => {
            searchVenueBtn.innerHTML = '<i class="fas fa-search"></i> Search';
            searchVenueBtn.disabled = false;
        });
    }
    
    function displayVenueSearchResults(venueInfo) {
        document.getElementById('venue-address').textContent = venueInfo.address;
        document.getElementById('venue-distance').textContent = `${venueInfo.distance_km} km`;
        document.getElementById('venue-time').textContent = venueInfo.travel_time;
        document.getElementById('venue-zone').textContent = venueInfo.travel_zone || '-';
        document.getElementById('venue-fee').textContent = `$${venueInfo.travel_fee.toFixed(2)}`;
        document.getElementById('venue-maps-link').href = venueInfo.maps_url;
        
        venueSearchResults.style.display = 'block';
    }
    
    // Utility functions
    function truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }
    
    function getCsrfToken() {
        return document.querySelector('[name=csrf_token]')?.value || '';
    }
    
    function showSuccess(message) {
        // You can implement a toast notification system here
        alert('Success: ' + message);
    }
    
    function showError(message) {
        // You can implement a toast notification system here
        alert('Error: ' + message);
    }
    
    // Global functions for inline handlers
    window.calculateSingleDistance = function(coupleId) {
        fetch(`/api/maps/update-couple-travel/${coupleId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the display
                const travelInfo = data.travel_info;
                document.getElementById(`distance-${coupleId}`).textContent = travelInfo.distance_text;
                document.getElementById(`time-${coupleId}`).textContent = travelInfo.duration_text;
                document.getElementById(`fee-${coupleId}`).textContent = `$${travelInfo.travel_fee.toFixed(2)}`;
                showSuccess('Travel information updated');
            } else {
                showError(data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Failed to calculate distance');
        });
    };
    
    window.viewInMaps = function(address) {
        const mapsUrl = `https://www.google.com/maps/dir/Melbourne,+VIC,+Australia/${encodeURIComponent(address)}`;
        window.open(mapsUrl, '_blank');
    };
});
</script>
{% endblock %} 
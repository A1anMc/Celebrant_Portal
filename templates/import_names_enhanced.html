{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Enhanced Import</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Step 1: File Upload -->
    <div class="card mb-4" id="uploadCard">
        <div class="card-body">
            <h5 class="card-title">Step 1: Upload CSV File</h5>
            <form id="uploadForm" class="mb-3">
                <div class="mb-3">
                    <label for="file" class="form-label">Choose CSV File</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                </div>
                <div class="mb-3">
                    <label for="chunkSize" class="form-label">Chunk Size</label>
                    <select class="form-select" id="chunkSize" name="chunkSize">
                        <option value="50">50 rows per chunk</option>
                        <option value="100" selected>100 rows per chunk</option>
                        <option value="250">250 rows per chunk</option>
                        <option value="500">500 rows per chunk</option>
                    </select>
                    <div class="form-text">Larger chunks process faster but use more memory.</div>
                </div>
                <button type="submit" class="btn btn-primary">Upload and Preview</button>
            </form>
        </div>
    </div>
    
    <!-- Step 2: Column Mapping -->
    <div class="card mb-4" id="mappingCard" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">Step 2: Map Columns</h5>
            <div class="alert alert-info">
                Match your CSV columns to the required fields. Required fields are marked with *.
            </div>
            <form id="mappingForm">
                <div id="columnMappings" class="row">
                    <!-- Will be populated dynamically -->
                </div>
                <button type="submit" class="btn btn-primary mt-3">Save Mapping</button>
            </form>
        </div>
    </div>
    
    <!-- Step 3: Data Preview -->
    <div class="card mb-4" id="previewCard" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">Step 3: Preview and Validate</h5>
            <div class="table-responsive">
                <table class="table table-sm" id="previewTable">
                    <thead>
                        <!-- Will be populated dynamically -->
                    </thead>
                    <tbody>
                        <!-- Will be populated dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-secondary" id="prevPage">Previous</button>
                <span id="pageInfo" class="mx-3">Page 1 of 1</span>
                <button type="button" class="btn btn-secondary" id="nextPage">Next</button>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-primary" id="startImport">Start Import</button>
            </div>
        </div>
    </div>
    
    <!-- Step 4: Import Progress -->
    <div class="card mb-4" id="progressCard" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">Step 4: Import Progress</h5>
            <div class="progress mb-3">
                <div class="progress-bar progress-bar-striped" id="importProgress" 
                     role="progressbar" style="width: 0%" 
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div id="progressStats">
                    Processed: <span id="processedRows">0</span> / <span id="totalRows">0</span>
                </div>
                <div>
                    <button type="button" class="btn btn-warning" id="pauseImport">Pause</button>
                    <button type="button" class="btn btn-danger" id="cancelImport">Cancel</button>
                </div>
            </div>
            <div id="errorList" class="mt-3">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSession = null;
let previewData = null;
let currentPage = 1;
const rowsPerPage = 10;

document.addEventListener('DOMContentLoaded', function() {
    // File Upload Handler
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/import/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            if (result.success) {
                currentSession = result.session;
                previewData = result.preview_data;
                
                // Show column mapping
                document.getElementById('uploadCard').style.display = 'none';
                document.getElementById('mappingCard').style.display = 'block';
                
                // Populate column mappings
                populateColumnMappings(result.columns);
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error uploading file: ' + error.message);
        }
    });
    
    // Column Mapping Handler
    document.getElementById('mappingForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const mappings = {};
        document.querySelectorAll('#columnMappings select').forEach(select => {
            mappings[select.dataset.column] = select.value;
        });
        
        try {
            const response = await fetch('/api/import/map-columns', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: currentSession.id,
                    mappings: mappings
                })
            });
            
            const result = await response.json();
            if (result.success) {
                // Show preview
                document.getElementById('mappingCard').style.display = 'none';
                document.getElementById('previewCard').style.display = 'block';
                updatePreview();
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error saving mappings: ' + error.message);
        }
    });
    
    // Preview Navigation
    document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            updatePreview();
        }
    });
    
    document.getElementById('nextPage').addEventListener('click', function() {
        const maxPages = Math.ceil(previewData.length / rowsPerPage);
        if (currentPage < maxPages) {
            currentPage++;
            updatePreview();
        }
    });
    
    // Import Control
    document.getElementById('startImport').addEventListener('click', startImport);
    document.getElementById('pauseImport').addEventListener('click', pauseImport);
    document.getElementById('cancelImport').addEventListener('click', cancelImport);
});

function populateColumnMappings(columns) {
    const container = document.getElementById('columnMappings');
    container.innerHTML = '';
    
    const requiredFields = ['Couple', 'Date'];
    const optionalFields = ['Location', 'Guest Count', 'Ceremony Time', 'Role', 
                          'Package', 'Fee', 'Travel Fee', 'Vows', 'Confirmed', 'Notes'];
    
    columns.forEach(column => {
        const div = document.createElement('div');
        div.className = 'col-md-4 mb-3';
        
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = column;
        
        const select = document.createElement('select');
        select.className = 'form-select';
        select.dataset.column = column;
        
        // Add "Do not import" option
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = '-- Do not import --';
        select.appendChild(noneOption);
        
        // Add required fields
        const requiredOptgroup = document.createElement('optgroup');
        requiredOptgroup.label = 'Required Fields';
        requiredFields.forEach(field => {
            const option = document.createElement('option');
            option.value = field;
            option.textContent = field + ' *';
            option.selected = field.toLowerCase() === column.toLowerCase();
            requiredOptgroup.appendChild(option);
        });
        select.appendChild(requiredOptgroup);
        
        // Add optional fields
        const optionalOptgroup = document.createElement('optgroup');
        optionalOptgroup.label = 'Optional Fields';
        optionalFields.forEach(field => {
            const option = document.createElement('option');
            option.value = field;
            option.textContent = field;
            option.selected = field.toLowerCase() === column.toLowerCase();
            optionalOptgroup.appendChild(option);
        });
        select.appendChild(optionalOptgroup);
        
        div.appendChild(label);
        div.appendChild(select);
        container.appendChild(div);
    });
}

function updatePreview() {
    const table = document.getElementById('previewTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    
    // Update headers
    thead.innerHTML = '<tr>' + 
        Object.keys(previewData[0]).map(key => `<th>${key}</th>`).join('') +
        '</tr>';
    
    // Update body
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = previewData.slice(start, end);
    
    tbody.innerHTML = pageData.map(row => 
        '<tr>' + Object.values(row).map(val => `<td>${val}</td>`).join('') + '</tr>'
    ).join('');
    
    // Update pagination info
    const maxPages = Math.ceil(previewData.length / rowsPerPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${maxPages}`;
    
    // Update button states
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === maxPages;
}

async function startImport() {
    try {
        document.getElementById('previewCard').style.display = 'none';
        document.getElementById('progressCard').style.display = 'block';
        
        const response = await fetch('/api/import/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: currentSession.id
            })
        });
        
        if (response.ok) {
            pollProgress();
        } else {
            const result = await response.json();
            alert('Error starting import: ' + result.error);
        }
    } catch (error) {
        alert('Error starting import: ' + error.message);
    }
}

async function pauseImport() {
    try {
        const response = await fetch('/api/import/pause', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: currentSession.id
            })
        });
        
        if (response.ok) {
            document.getElementById('pauseImport').textContent = 
                currentSession.status === 'paused' ? 'Resume' : 'Pause';
        } else {
            const result = await response.json();
            alert('Error pausing import: ' + result.error);
        }
    } catch (error) {
        alert('Error pausing import: ' + error.message);
    }
}

async function cancelImport() {
    if (!confirm('Are you sure you want to cancel the import? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/import/cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                session_id: currentSession.id
            })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            alert('Error canceling import: ' + result.error);
        }
    } catch (error) {
        alert('Error canceling import: ' + error.message);
    }
}

async function pollProgress() {
    try {
        const response = await fetch(`/api/import/status/${currentSession.id}`);
        const status = await response.json();
        
        // Update progress bar
        const progress = status.progress;
        const progressBar = document.getElementById('importProgress');
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        
        // Update stats
        document.getElementById('processedRows').textContent = status.processed_rows;
        document.getElementById('totalRows').textContent = status.total_rows;
        
        // Update errors
        const errorList = document.getElementById('errorList');
        if (status.errors.length > 0) {
            errorList.innerHTML = '<h6 class="text-danger">Errors:</h6><ul class="list-group">' +
                status.errors.map(error => 
                    `<li class="list-group-item list-group-item-danger">${error}</li>`
                ).join('') + '</ul>';
        }
        
        // Continue polling if not complete
        if (status.status !== 'completed' && status.status !== 'failed') {
            setTimeout(pollProgress, 1000);
        } else if (status.status === 'completed') {
            alert('Import completed successfully!');
            location.reload();
        }
    } catch (error) {
        alert('Error checking progress: ' + error.message);
    }
}
</script>
{% endblock %} 
{% extends "base.html" %}

{% block title %}Edit Couple - Marriage Celebrant Portal{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-modern">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('couples_list') }}">Couples</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('couple_view', id=couple.id) }}">{{ couple.partner1_name }} & {{ couple.partner2_name }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Edit</li>
    </ol>
</nav>

<!-- Action Bar -->
<div class="action-bar">
    <div class="title-section">
        <h1>Edit Couple</h1>
        <div class="subtitle">{{ couple.partner1_name }} & {{ couple.partner2_name }}</div>
    </div>
    <div class="actions">
        <a href="{{ url_for('couple_view', id=couple.id) }}" class="btn-secondary-action">
            <i class="bi bi-x-circle"></i> Cancel
        </a>
    </div>
</div>

<!-- Progress Indicator -->
<div class="step-progress mb-4">
    <div class="step completed">
        <div class="step-number">1</div>
        <div class="step-label">Partners</div>
    </div>
    <div class="step active">
        <div class="step-number">2</div>
        <div class="step-label">Ceremony</div>
    </div>
    <div class="step">
        <div class="step-number">3</div>
        <div class="step-label">Details</div>
    </div>
</div>

<form method="POST" id="coupleForm" class="needs-validation" novalidate>
    {{ form.csrf_token }}
    
    <!-- Partner Information Section -->
    <div class="card card-modern mb-4">
        <div class="card-header card-header-modern">
            <h5 class="mb-0">
                <i class="bi bi-people"></i> Partner Information
            </h5>
        </div>
        <div class="card-body card-body-modern">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-person"></i> Partner 1
                    </h6>
                    <div class="mb-3">
                        {{ form.partner1_name.label(class="form-label") }}
                        {{ form.partner1_name(class="form-control form-control-enhanced", placeholder="Enter full name") }}
                        {% if form.partner1_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.partner1_name.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.partner1_email.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            {{ form.partner1_email(class="form-control form-control-enhanced", placeholder="partner1@example.com") }}
                        </div>
                        {% if form.partner1_email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.partner1_email.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.partner1_phone.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                            {{ form.partner1_phone(class="form-control form-control-enhanced", placeholder="0400 000 000") }}
                        </div>
                        {% if form.partner1_phone.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.partner1_phone.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-6">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-person"></i> Partner 2
                    </h6>
                    <div class="mb-3">
                        {{ form.partner2_name.label(class="form-label") }}
                        {{ form.partner2_name(class="form-control form-control-enhanced", placeholder="Enter full name") }}
                        {% if form.partner2_name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.partner2_name.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.partner2_email.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            {{ form.partner2_email(class="form-control form-control-enhanced", placeholder="partner2@example.com") }}
                        </div>
                        {% if form.partner2_email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.partner2_email.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        {{ form.partner2_phone.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                            {{ form.partner2_phone(class="form-control form-control-enhanced", placeholder="0400 000 000") }}
                        </div>
                        {% if form.partner2_phone.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.partner2_phone.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ceremony Details Section -->
    <div class="card card-modern mb-4">
        <div class="card-header card-header-modern">
            <h5 class="mb-0">
                <i class="bi bi-calendar-heart"></i> Ceremony Details
            </h5>
        </div>
        <div class="card-body card-body-modern">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.ceremony_date.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                            {{ form.ceremony_date(class="form-control form-control-enhanced", type="date") }}
                        </div>
                        {% if form.ceremony_date.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.ceremony_date.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        {{ form.status.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-flag"></i></span>
                            {{ form.status(class="form-select form-control-enhanced") }}
                        </div>
                        {% if form.status.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.status.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                {{ form.ceremony_location.label(class="form-label") }}
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                    {{ form.ceremony_location(class="form-control form-control-enhanced", id="ceremony_location", placeholder="e.g. Royal Botanic Gardens, Melbourne, VIC 3141") }}
                    <button type="button" class="btn btn-outline-primary" id="calculate-distance-btn">
                        <i class="bi bi-map"></i> Calculate Distance
                    </button>
                </div>
                {% if form.ceremony_location.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.ceremony_location.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
                <div class="form-text">Enter the complete venue address to calculate travel distance and fee automatically</div>
            </div>

            <!-- Travel Information Section -->
            <div class="row mt-3" id="travel-info-section" style="display: none;">
                <div class="col-12">
                    <div class="alert alert-modern alert-info">
                        <h6 class="alert-heading">
                            <i class="bi bi-route"></i> Travel Information
                        </h6>
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Distance:</strong>
                                <div id="travel-distance" class="fw-semibold text-primary">-</div>
                            </div>
                            <div class="col-md-3">
                                <strong>Travel Time:</strong>
                                <div id="travel-time" class="fw-semibold text-primary">-</div>
                            </div>
                            <div class="col-md-3">
                                <strong>Zone & Fee:</strong>
                                <div id="calculated-fee" class="fw-semibold text-success">-</div>
                            </div>
                            <div class="col-md-3">
                                <a id="maps-link" href="#" target="_blank" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-map"></i> View Route
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Embedded Map -->
            <div class="row mt-3" id="embedded-map-section" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-map"></i> Route to Venue
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggle-map">
                                <i class="bi bi-eye-slash"></i> Hide Map
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <iframe id="maps-embed" width="100%" height="400" frameborder="0" style="border:0" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="travel_fee" class="form-label">Travel Fee ($)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" class="form-control form-control-enhanced" id="travel_fee" name="travel_fee" 
                                   value="{{ couple.travel_fee or '' }}" placeholder="0.00">
                        </div>
                        <div class="form-text">Automatically calculated based on distance zones</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- Auto-save indicator -->
                    <div class="d-flex align-items-center justify-content-end mt-4">
                        <div id="save-status" class="text-muted small">
                            <i class="bi bi-cloud-check"></i> Changes saved automatically
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Details Section -->
    <div class="card card-modern mb-4">
        <div class="card-header card-header-modern">
            <h5 class="mb-0">
                <i class="bi bi-journal-text"></i> Additional Details
            </h5>
        </div>
        <div class="card-body card-body-modern">
            <div class="mb-3">
                {{ form.notes.label(class="form-label") }}
                {{ form.notes(class="form-control form-control-enhanced", rows="4", placeholder="Add any special notes, requirements, or details about the ceremony...") }}
                {% if form.notes.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.notes.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
                <div class="form-text">Use this space for ceremony preferences, special requests, or important reminders</div>
            </div>
        </div>
    </div>

    <!-- Form Actions -->
    <div class="card card-modern">
        <div class="card-body card-body-modern">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Last updated: {{ couple.updated_at.strftime('%d %b %Y at %I:%M %p') if couple.updated_at else 'Never' }}
                </div>
                <div class="d-flex gap-3">
                    <a href="{{ url_for('couple_view', id=couple.id) }}" class="btn-secondary-action">
                        <i class="bi bi-eye"></i> Preview
                    </a>
                    <button type="submit" class="btn-primary-action" id="save-btn">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="text-center">
        <div class="loading-spinner"></div>
        <div class="loading-text">Saving changes...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-save functionality
let autoSaveTimeout;
let hasChanges = false;

// Track form changes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('coupleForm');
    const saveStatus = document.getElementById('save-status');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    // Track changes
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            hasChanges = true;
            showSaveStatus('pending');
            
            // Clear existing timeout
            clearTimeout(autoSaveTimeout);
            
            // Set new timeout for auto-save
            autoSaveTimeout = setTimeout(() => {
                if (hasChanges) {
                    autoSave();
                }
            }, 2000); // Auto-save after 2 seconds of inactivity
        });
    });
    
    // Form validation
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
            showValidationErrors();
        } else {
            showLoading('Saving changes...');
        }
        form.classList.add('was-validated');
    });
});

function showSaveStatus(status) {
    const saveStatus = document.getElementById('save-status');
    const icons = {
        pending: 'bi-clock',
        saving: 'bi-arrow-repeat',
        saved: 'bi-cloud-check',
        error: 'bi-exclamation-triangle'
    };
    
    const messages = {
        pending: 'Unsaved changes',
        saving: 'Saving...',
        saved: 'All changes saved',
        error: 'Error saving changes'
    };
    
    const colors = {
        pending: 'text-warning',
        saving: 'text-info',
        saved: 'text-success',
        error: 'text-danger'
    };
    
    saveStatus.className = `small ${colors[status]}`;
    saveStatus.innerHTML = `<i class="bi ${icons[status]} me-1"></i> ${messages[status]}`;
}

function autoSave() {
    // This would implement auto-save functionality
    // For now, just show the saving status
    showSaveStatus('saving');
    
    setTimeout(() => {
        showSaveStatus('saved');
        hasChanges = false;
    }, 1000);
}

function showValidationErrors() {
    const firstError = document.querySelector('.is-invalid, .form-control:invalid');
    if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
    }
}

// Distance calculation functionality (enhanced from existing)
document.getElementById('calculate-distance-btn').addEventListener('click', function() {
    const locationInput = document.getElementById('ceremony_location');
    const location = locationInput.value.trim();
    
    if (!location) {
        showAddressError('Please enter a ceremony location first');
        locationInput.focus();
        return;
    }
    
    if (location.length < 10) {
        showAddressError('Please enter a more complete address (e.g., "123 Collins Street, Melbourne VIC 3000")');
        locationInput.focus();
        return;
    }
    
    calculateDistance(location);
});

function calculateDistance(address) {
    const btn = document.getElementById('calculate-distance-btn');
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.innerHTML = '<div class="loading-spinner me-2"></div>Calculating...';
    btn.disabled = true;
    
    fetch('/api/maps/calculate-distance', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
        },
        body: JSON.stringify({
            destination: address
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayTravelInfo(data);
            updateTravelFee(data.travel_fee);
            showEmbeddedMap(data);
        } else {
            showAddressError(data.error || 'Could not calculate distance');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAddressError('Network error. Please try again.');
    })
    .finally(() => {
        // Restore button
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function displayTravelInfo(data) {
    document.getElementById('travel-distance').textContent = data.distance;
    document.getElementById('travel-time').textContent = data.duration;
    document.getElementById('calculated-fee').innerHTML = `
        <span class="badge bg-primary me-1">${data.zone_info.zone}</span>
        $${data.travel_fee.toFixed(2)}
    `;
    
    // Update maps link
    const mapsLink = document.getElementById('maps-link');
    mapsLink.href = data.maps_url;
    
    // Show travel info section
    document.getElementById('travel-info-section').style.display = 'block';
}

function updateTravelFee(fee) {
    const travelFeeInput = document.getElementById('travel_fee');
    travelFeeInput.value = fee.toFixed(2);
    
    // Trigger change event for auto-save
    travelFeeInput.dispatchEvent(new Event('input'));
}

function showEmbeddedMap(data) {
    const embedUrl = `https://www.google.com/maps/embed/v1/directions?key={{ config.GOOGLE_MAPS_API_KEY }}&origin=1+Hunter+Street,+Brunswick+West+VIC+3055&destination=${encodeURIComponent(data.destination_address)}&mode=driving`;
    
    document.getElementById('maps-embed').src = embedUrl;
    document.getElementById('embedded-map-section').style.display = 'block';
    
    // Update toggle button
    const toggleBtn = document.getElementById('toggle-map');
    toggleBtn.onclick = function() {
        const mapSection = document.getElementById('embedded-map-section');
        const isVisible = mapSection.style.display !== 'none';
        
        mapSection.style.display = isVisible ? 'none' : 'block';
        toggleBtn.innerHTML = isVisible ? '<i class="bi bi-eye"></i> Show Map' : '<i class="bi bi-eye-slash"></i> Hide Map';
    };
}

function showAddressError(message) {
    // Create or update error message
    let errorDiv = document.getElementById('address-error');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'address-error';
        errorDiv.className = 'alert alert-modern alert-danger mt-2';
        document.getElementById('ceremony_location').parentNode.parentNode.appendChild(errorDiv);
    }
    
    errorDiv.innerHTML = `
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Address Error:</strong> ${message}
        <div class="mt-2 small">
            <strong>Tips:</strong>
            <ul class="mb-0 mt-1">
                <li>Include street number and name</li>
                <li>Add suburb/city and state</li>
                <li>Include postcode if possible</li>
                <li>Example: "123 Collins Street, Melbourne VIC 3000"</li>
            </ul>
        </div>
    `;
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        if (errorDiv) {
            errorDiv.remove();
        }
    }, 10000);
}

function showLoading(message = 'Loading...') {
    const overlay = document.getElementById('loadingOverlay');
    const text = overlay.querySelector('.loading-text');
    text.textContent = message;
    overlay.style.display = 'flex';
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S = Save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('coupleForm').requestSubmit();
    }
    
    // Ctrl/Cmd + Enter = Calculate Distance
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('calculate-distance-btn').click();
    }
});

// Add tooltips for keyboard shortcuts
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('save-btn').title = 'Save Changes (Ctrl+S)';
    document.getElementById('calculate-distance-btn').title = 'Calculate Distance (Ctrl+Enter)';
});
</script>
{% endblock %} 
# 🚀 Render Unified Deployment Guide
## Melbourne Celebrant Portal - Complete Application on Render

This guide covers deploying the entire Melbourne Celebrant Portal (frontend + backend) as a single service on Render using Docker.

---

## 📋 Overview

### **Unified Architecture**
- **Single Container**: Both Next.js frontend and FastAPI backend
- **Port 8000**: FastAPI serves as reverse proxy to Next.js on port 3000
- **Database**: Separate PostgreSQL service on Render
- **Cost**: 100% free using Render's free tier

### **Benefits**
- ✅ **Simplified Deployment**: One service instead of two
- ✅ **No CORS Issues**: Frontend and backend on same host
- ✅ **Cost Effective**: Single service reduces resource usage
- ✅ **Easy Management**: One service to monitor and manage

---

## 🛠️ Deployment Methods

### **Method 1: Using render.yaml (Recommended)**

#### **1. Prepare Repository**
Ensure your repository has these files at the project root:
```
celebrant-portal-v2/
├── render.yaml              # Render configuration
├── Dockerfile               # Multi-stage Docker build
├── start.sh                 # Startup script
├── Procfile                 # Process definition
├── backend/                 # FastAPI application
├── frontend/                # Next.js application
└── RENDER_DEPLOYMENT.md     # This guide
```

#### **2. Deploy via Render Dashboard**
1. **Go to [Render Dashboard](https://dashboard.render.com/)**
2. **Click "New +"** → **"Blueprint"**
3. **Connect GitHub repository**
4. **Select branch**: `main`
5. **Render will automatically**:
   - Create PostgreSQL database
   - Build and deploy the unified application
   - Set up environment variables
   - Configure health checks

#### **3. Monitor Deployment**
- **Build logs**: Watch Docker build process
- **Deploy logs**: Monitor startup sequence
- **Health check**: Verify `/health` endpoint responds

---

### **Method 2: Manual Setup**

#### **1. Create Database**
1. **In Render Dashboard**: New + → PostgreSQL
2. **Configuration**:
   - Name: `melbourne-celebrant-db`
   - Database: `celebrant_portal`
   - User: `celebrant_user`
   - Plan: **Free**
3. **Save connection string** for next step

#### **2. Create Web Service**
1. **In Render Dashboard**: New + → Web Service
2. **Configuration**:
   - **Environment**: Docker
   - **Repository**: Your GitHub repo
   - **Branch**: `main`
   - **Dockerfile Path**: `./Dockerfile`
   - **Docker Context**: `.`
   - **Plan**: **Free**

#### **3. Set Environment Variables**
```bash
# Application
ENVIRONMENT=production
DEBUG=false
NODE_ENV=production

# Security (Render will generate)
SECRET_KEY=<auto-generated-secure-key>
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=30

# Database (from step 1)
DATABASE_URL=postgresql://celebrant_user:password@host/celebrant_portal

# API Configuration
NEXT_PUBLIC_API_URL=""
NEXT_PUBLIC_APP_NAME="Melbourne Celebrant Portal"
NEXT_PUBLIC_APP_VERSION="2.0.0"

# CORS (unified deployment)
CORS_ORIGINS=["*"]
```

---

## 🏗️ Technical Architecture

### **Container Structure**
```
Docker Container (Port 8000)
├── FastAPI Backend (Port 8000) - Main service
│   ├── API endpoints (/api/*)
│   ├── Health check (/health)
│   ├── API docs (/docs)
│   └── Proxy to frontend (/* → localhost:3000)
└── Next.js Frontend (Port 3000) - Internal
    ├── All application pages
    ├── Static assets
    └── Client-side routing
```

### **Request Flow**
1. **User visits**: `https://your-app.onrender.com/`
2. **FastAPI receives**: Request on port 8000
3. **FastAPI proxies**: Non-API requests to Next.js on port 3000
4. **Next.js serves**: Frontend application
5. **API calls**: Go directly to FastAPI on same host

### **Startup Sequence**
1. **Container starts**: Runs `start.sh`
2. **Next.js starts**: Port 3000 (background)
3. **Database migration**: Alembic upgrade head
4. **FastAPI starts**: Port 8000 (main process)
5. **Health check**: `/health` endpoint active
6. **Application ready**: Accepting traffic

---

## ✅ Verification Checklist

### **Deployment Success**
- [ ] **Build completes**: No Docker build errors
- [ ] **Services start**: Both Next.js and FastAPI running
- [ ] **Database connects**: No connection errors in logs
- [ ] **Health check passes**: `/health` returns 200
- [ ] **Frontend loads**: Application displays correctly
- [ ] **API works**: Login and dashboard function
- [ ] **Admin user exists**: Can login with default credentials

### **Performance Checks**
- [ ] **Load time**: < 5 seconds for initial page load
- [ ] **API response**: < 1 second for dashboard data
- [ ] **Navigation**: Client-side routing works smoothly
- [ ] **Styling**: Melbourne Celebrant branding displays correctly

---

## 🔧 Configuration Details

### **Environment Variables Explained**

#### **Application Settings**
```bash
ENVIRONMENT=production          # Sets production mode
DEBUG=false                    # Disables debug logging
NODE_ENV=production            # Optimizes Next.js for production
```

#### **Security Settings**
```bash
SECRET_KEY=<auto-generated>    # JWT signing key (Render generates)
ACCESS_TOKEN_EXPIRE_MINUTES=60 # JWT token expiry
REFRESH_TOKEN_EXPIRE_DAYS=30   # Refresh token expiry
```

#### **Database Settings**
```bash
DATABASE_URL=postgresql://...  # PostgreSQL connection string
```

#### **Frontend Settings**
```bash
NEXT_PUBLIC_API_URL=""         # Empty = same host (unified deployment)
NEXT_PUBLIC_APP_NAME="Melbourne Celebrant Portal"
NEXT_PUBLIC_APP_VERSION="2.0.0"
```

#### **CORS Settings**
```bash
CORS_ORIGINS=["*"]             # Allow all origins (unified deployment)
```

---

## 🚨 Troubleshooting

### **Common Issues**

#### **Build Failures**
```bash
# Check build logs for:
- Node.js version compatibility
- npm install errors
- TypeScript compilation errors
- Python dependency conflicts
```

#### **Startup Issues**
```bash
# Check deploy logs for:
- Database connection errors
- Port binding conflicts
- Permission issues
- Missing environment variables
```

#### **Runtime Problems**
```bash
# Check application logs for:
- Frontend proxy errors
- API endpoint failures
- Authentication issues
- Database query problems
```

### **Debug Commands**
```bash
# View container logs
render logs --service melbourne-celebrant-portal

# Check health endpoint
curl https://your-app.onrender.com/health

# Test API directly
curl https://your-app.onrender.com/api/auth/me

# Monitor database
render logs --database melbourne-celebrant-db
```

---

## 📊 Resource Usage

### **Free Tier Limits**
- **Web Service**: 750 hours/month (24/7 coverage)
- **Database**: 1GB storage, 100 connections
- **Build Time**: 15 minutes max per build
- **Memory**: 512MB RAM
- **CPU**: Shared CPU

### **Performance Expectations**
- **Cold Start**: 15-30 seconds after inactivity
- **Warm Response**: < 1 second
- **Concurrent Users**: 10-50 (free tier)
- **Database Queries**: < 100ms average

---

## 🔄 Updates and Maintenance

### **Automatic Deployments**
- **Git Push**: Automatically triggers new deployment
- **Build Process**: Rebuilds Docker container
- **Zero Downtime**: Render handles traffic switching
- **Rollback**: Previous versions available in dashboard

### **Manual Operations**
```bash
# Force redeploy (same code)
# In Render dashboard: Manual Deploy → Deploy Latest Commit

# Environment variable updates
# In Render dashboard: Environment → Edit → Save
# Note: Triggers automatic redeploy

# Database operations
# Use Render shell or external database client
```

---

## 🎯 Production Checklist

### **Before Going Live**
- [ ] **Change admin password**: From default admin123
- [ ] **Configure custom domain**: If desired
- [ ] **Set up monitoring**: UptimeRobot or similar
- [ ] **Configure email**: Brevo SMTP settings
- [ ] **Test all features**: Complete user journey
- [ ] **Performance test**: Load testing with expected traffic
- [ ] **Backup strategy**: Database backup plan

### **Post-Launch**
- [ ] **Monitor logs**: Check for errors and performance
- [ ] **User feedback**: Collect and address issues
- [ ] **Regular updates**: Keep dependencies current
- [ ] **Security reviews**: Regular security assessments

---

## 🌐 Live URLs

After successful deployment, your application will be available at:

- **Main Application**: `https://melbourne-celebrant-portal.onrender.com`
- **API Documentation**: `https://melbourne-celebrant-portal.onrender.com/docs`
- **Health Check**: `https://melbourne-celebrant-portal.onrender.com/health`
- **Admin Login**: Use `admin@melbournecelebrant.com` / `admin123`

---

## 💰 Cost Breakdown

### **Monthly Costs: $0**
- ✅ **Web Service**: Free (750 hours)
- ✅ **PostgreSQL**: Free (1GB)
- ✅ **Domain**: Free Render subdomain
- ✅ **SSL**: Free automatic HTTPS
- ✅ **CDN**: Free global distribution

### **Upgrade Options** (if needed)
- **Starter Plan**: $7/month (always-on, no cold starts)
- **Standard Plan**: $25/month (more resources, custom domains)
- **Pro Database**: $7/month (4GB storage, more connections)

---

## 🆘 Support

### **Render Resources**
- **Documentation**: [render.com/docs](https://render.com/docs)
- **Community**: [community.render.com](https://community.render.com)
- **Status**: [status.render.com](https://status.render.com)

### **Application Support**
- **Main Documentation**: `../README.md`
- **GitHub Issues**: Repository issue tracker
- **Logs**: Render dashboard → Service → Logs

---

🎉 **Your Melbourne Celebrant Portal is now running on Render with a unified, cost-effective deployment!** 